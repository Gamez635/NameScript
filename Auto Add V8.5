local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local lp = Players.LocalPlayer

local function randomString(length)
    length = length or 8
    local chars = "abcdefghijklmnopqrstuvwxyz"
    local result = ""
    for i = 1, length do
        result = result .. chars:sub(math.random(1, #chars), math.random(1, #chars))
    end
    return result
end

local sg = Instance.new("ScreenGui")
sg.ResetOnSpawn = false
sg.Parent = CoreGui

local mainBtn = Instance.new("TextButton")
mainBtn.Size = UDim2.new(0, 80, 0, 80)
mainBtn.Position = UDim2.new(0, 20, 0.5, -40)
mainBtn.Text = "V23"
mainBtn.Font = Enum.Font.GothamBlack
mainBtn.TextSize = 36
mainBtn.TextColor3 = Color3.new(1, 1, 1)
mainBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
mainBtn.Draggable = true
mainBtn.Parent = sg
Instance.new("UICorner", mainBtn).CornerRadius = UDim.new(1, 0)

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 320, 0, 440)
frame.Position = UDim2.new(0.5, -160, 0.5, -220)
frame.BackgroundColor3 = Color3.fromRGB(15, 15, 35)
frame.Visible = false
frame.Parent = sg
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 16)

mainBtn.MouseButton1Click:Connect(function()
    frame.Visible = not frame.Visible
    mainBtn.Text = frame.Visible and "X" or "V23"
end)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, -20, 0, 40)
title.Position = UDim2.new(0, 10, 0, 8)
title.Text = "V23 Smooth Cam"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.BackgroundTransparency = 1

local status = Instance.new("TextLabel", frame)
status.Size = UDim2.new(1, -20, 0, 26)
status.Position = UDim2.new(0, 10, 0, 48)
status.Text = "Frames: 0"
status.TextColor3 = Color3.fromRGB(100, 220, 255)
status.Font = Enum.Font.GothamSemibold
status.TextSize = 15
status.BackgroundTransparency = 1

local segLabel = Instance.new("TextLabel", frame)
segLabel.Size = UDim2.new(0.5, -15, 0, 30)
segLabel.Position = UDim2.new(0, 10, 0, 80)
segLabel.Text = "Frames per seg:"
segLabel.TextColor3 = Color3.new(1,1,1)
segLabel.Font = Enum.Font.GothamSemibold
segLabel.TextSize = 14
segLabel.BackgroundTransparency = 1
segLabel.TextXAlignment = Enum.TextXAlignment.Left

local segInput = Instance.new("TextBox", frame)
segInput.Size = UDim2.new(0.5, -15, 0, 30)
segInput.Position = UDim2.new(0.5, 5, 0, 80)
segInput.Text = "150"
segInput.Font = Enum.Font.Gotham
segInput.TextSize = 16
segInput.BackgroundColor3 = Color3.fromRGB(30,30,50)
segInput.TextColor3 = Color3.new(1,1,1)
segInput.ClearTextOnFocus = false
Instance.new("UICorner", segInput).CornerRadius = UDim.new(0,8)

local progressLabel = Instance.new("TextLabel", frame)
progressLabel.Size = UDim2.new(1, -20, 0, 24)
progressLabel.Position = UDim2.new(0, 10, 0, 115)
progressLabel.Text = "Progress: Ready"
progressLabel.TextColor3 = Color3.fromRGB(200, 200, 255)
progressLabel.Font = Enum.Font.Gotham
progressLabel.TextSize = 14
progressLabel.BackgroundTransparency = 1

local scroll = Instance.new("ScrollingFrame", frame)
scroll.Size = UDim2.new(1, -20, 1, -230)
scroll.Position = UDim2.new(0, 10, 0, 145)
scroll.ScrollBarThickness = 5
scroll.BackgroundTransparency = 1

local layout = Instance.new("UIListLayout", scroll)
layout.Padding = UDim.new(0, 8)
layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    scroll.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 20)
end)

local frames = {}
local isRecording = false
local exportedUpTo = 0

local function createBtn(text, col, cb)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(1, -10, 0, 42)
    b.BackgroundColor3 = col
    b.Text = text
    b.Font = Enum.Font.GothamBold
    b.TextSize = 15
    b.TextColor3 = Color3.new(1, 1, 1)
    b.Parent = scroll
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 10)
    b.MouseButton1Click:Connect(function()
        task.spawn(function()
            pcall(cb, b)
        end)
    end)
end

local function formatCFrame(cf)
    if not cf then return "CFrame.new(0,0,0)" end
    local x,y,z,r00,r01,r02,r10,r11,r12,r20,r21,r22 = cf:components()
    return string.format("CFrame.new(%.3f,%.3f,%.3f,%.6f,%.6f,%.6f,%.6f,%.6f,%.6f,%.6f,%.6f,%.6f)",
        x or 0, y or 0, z or 0,
        r00 or 1, r01 or 0, r02 or 0,
        r10 or 0, r11 or 0, r12 or 1,
        r20 or 0, r21 or 0, r22 or 0)
end

createBtn("Record: OFF", Color3.fromRGB(220, 50, 50), function(b)
    isRecording = not isRecording
    b.Text = isRecording and "Record: ON" or "Record: OFF"
    b.BackgroundColor3 = isRecording and Color3.fromRGB(50, 220, 80) or Color3.fromRGB(220, 50, 50)
end)

createBtn("Clear All", Color3.fromRGB(180, 60, 60), function()
    frames = {}
    exportedUpTo = 0
    status.Text = "Frames: 0"
    progressLabel.Text = "Progress: Ready"
end)

createBtn("Export Combined", Color3.fromRGB(100, 255, 100), function(b)
    if #frames < 50 then 
        b.Text = "Too few!"
        task.wait(1)
        b.Text = "Export Combined"
        return 
    end

    b.Text = "Building... (" .. #frames .. "f)"
    progressLabel.Text = "Progress: 0%"

    task.spawn(function()
        local codeParts = {}
        table.insert(codeParts, [[
-- V23 Smooth Cam - Combined & Fixed 2025 (better transitions)
-- Transisi antar segmen jauh lebih mulus dengan crossfade kecil

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local cam = workspace.CurrentCamera
local char = lp.Character or lp.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local hum = char:WaitForChild("Humanoid")

hum.AutoRotate = false
cam.CameraType = Enum.CameraType.Scriptable

local frames = {
]])

        local total = #frames
        for i, f in ipairs(frames) do
            local relTime = f.Time

            local entry = string.format(
                "{Pos=Vector3.new(%.3f,%.3f,%.3f),Vel=Vector3.new(%.3f,%.3f,%.3f),Move=Vector3.new(%.3f,0,%.3f),Jump=%s,CFrame=%s,FOV=%.2f,Time=%.4f}%s\n",
                f.Pos.X, f.Pos.Y, f.Pos.Z,
                f.Vel.X, f.Vel.Y, f.Vel.Z,
                f.Move.X, f.Move.Z,
                tostring(f.Jump),
                formatCFrame(f.CFrame),
                f.FOV or 70,
                relTime,
                i < total and "," or ""
            )
            table.insert(codeParts, entry)

            if i % 500 == 0 then
                progressLabel.Text = "Progress: " .. math.floor((i / total) * 100) .. "%"
                task.wait()
            end
        end

        table.insert(codeParts, [[
}

-- === Playback Engine dengan transisi mulus ===
local t = 0
local prevFrame = nil
local nextFrame = nil
local blendStartT = 0
local BLEND_DURATION = 0.10   -- durasi crossfade antar segmen (detik)

local lastCFrame = cam.CFrame
local lastPos = Vector3.zero
local lastLookFlat = Vector3.zero

RunService.RenderStepped:Connect(function(dt)
    t += dt
    
    local lastRecordedTime = frames[#frames].Time
    if t > lastRecordedTime + 0.25 then 
        -- sudah lewat → freeze di pose akhir
        cam.CFrame = lastCFrame
        return 
    end
    
    -- Cari dua frame yang mengapit waktu saat ini
    local found = false
    for i = 1, #frames - 1 do
        local a = frames[i]
        local b = frames[i + 1]
        
        if t >= a.Time and t <= b.Time then
            prevFrame = a
            nextFrame = b
            found = true
            break
        end
    end
    
    if not found then
        -- di luar range → pakai frame terakhir
        local last = frames[#frames]
        cam.CFrame = last.CFrame
        cam.FieldOfView = last.FOV or 70
        lastCFrame = last.CFrame
        return
    end
    
    local a, b = prevFrame, nextFrame
    
    local alpha = (t - a.Time) / (b.Time - a.Time)
    alpha = math.clamp(alpha, 0, 1)
    
    -- === Crossfade logic jika mendekati transisi segmen berikutnya ===
    local isNearTransition = (b.Time - t) < BLEND_DURATION
    
    local finalPos, finalVel, finalMove, finalFOV, finalCFrame
    
    if isNearTransition and i < #frames - 1 then
        -- mulai blend ke segmen berikutnya
        local nextA = frames[i + 1]  -- b sekarang
        local nextB = frames[i + 2]
        
        local blendAlpha = (t - (b.Time - BLEND_DURATION)) / BLEND_DURATION
        blendAlpha = math.clamp(blendAlpha, 0, 1)
        
        local posA = a.Pos:Lerp(b.Pos, alpha)
        local posB = nextA.Pos:Lerp(nextB.Pos, blendAlpha)
        finalPos = posA:Lerp(posB, blendAlpha)
        
        local velA = a.Vel:Lerp(b.Vel, alpha)
        local velB = nextA.Vel:Lerp(nextB.Vel, blendAlpha)
        finalVel = velA:Lerp(velB, blendAlpha)
        
        local moveA = a.Move:Lerp(b.Move, alpha)
        local moveB = nextA.Move:Lerp(nextB.Move, blendAlpha)
        finalMove = moveA:Lerp(moveB, blendAlpha)
        
        finalFOV = (a.FOV + (b.FOV - a.FOV) * alpha) * (1 - blendAlpha) 
                 + (nextA.FOV + (nextB.FOV - nextA.FOV) * blendAlpha) * blendAlpha
        
        local cfA = a.CFrame:Lerp(b.CFrame, alpha)
        local cfB = nextA.CFrame:Lerp(nextB.CFrame, blendAlpha)
        finalCFrame = cfA:Lerp(cfB, blendAlpha)
    else
        -- normal interpolation
        finalPos    = a.Pos:Lerp(b.Pos, alpha)
        finalVel    = a.Vel:Lerp(b.Vel, alpha)
        finalMove   = a.Move:Lerp(b.Move, alpha)
        finalFOV    = a.FOV + (b.FOV - a.FOV) * alpha
        finalCFrame = a.CFrame:Lerp(b.CFrame, alpha)
    end
    
    lastCFrame = finalCFrame
    lastPos = finalPos
    
    cam.CFrame = finalCFrame
    cam.FieldOfView = finalFOV
    
    -- Align karakter (dengan smoothing look direction)
    local lookFlat = Vector3.new(finalCFrame.LookVector.X, 0, finalCFrame.LookVector.Z)
    if lookFlat.Magnitude > 0.001 then
        lookFlat = lookFlat.Unit
        if lastLookFlat.Magnitude > 0 then
            lookFlat = lastLookFlat:Lerp(lookFlat, 0.25) -- smooth turn
        end
        lastLookFlat = lookFlat
        
        hrp.CFrame = CFrame.new(finalPos, finalPos + lookFlat * 10)
    end
    
    hum:Move(finalMove, true)
    hrp.AssemblyLinearVelocity = finalVel
    
    -- Jump (simple)
    if a.Jump or b.Jump then
        hum.Jump = (alpha < 0.6 and a.Jump) or (alpha >= 0.4 and b.Jump)
    end
end)
]])

        local fullCode = table.concat(codeParts)
        local rand = randomString(10)
        local filename = "v23_smooth_fixed_nojump_" .. rand .. ".lua"

        if writefile then
            writefile(filename, fullCode)
            b.Text = "Exported! (" .. #frames .. "f)"
            progressLabel.Text = "Progress: 100% ✓"
        else
            b.Text = "writefile not found"
            progressLabel.Text = "Error: butuh exploit yang support writefile"
        end

        task.wait(3.5)
        b.Text = "Export Combined"
        progressLabel.Text = "Progress: Ready"
    end)
end)

local lt = tick()
RunService.Heartbeat:Connect(function()
    if not isRecording then return end
    local char = lp.Character
    if not char then return end
    local hum = char:FindFirstChild("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    local cam = workspace.CurrentCamera
    if not (hum and root and cam and cam.CFrame) then return end
    
    local now = tick()
    local dt = now - lt
    if dt < 0.001 then return end
    lt = now
    
    table.insert(frames, {
        Pos = root.Position,
        Vel = root.AssemblyLinearVelocity,
        Move = hum.MoveDirection,
        Jump = hum.Jump,
        CFrame = cam.CFrame,
        FOV = cam.FieldOfView,
        Time = #frames == 0 and 0 or frames[#frames].Time + dt
    })
    
    status.Text = "Frames: " .. #frames
end)
